# First experiment notes

Note author: nekevss

This is a much delayed first entry in the notes section for `oscars`. But better late
than never. So let's get started.

## Background and research

@hansl tooks a pass at implementing a mempool allocator for Boa. It's as a good a
starting point as any and has the potential to serve as a good baseline.

Why a mempool allocator? They are a great way to allocate memory in a way that is fast
and -- potentially -- cache-friendly.

Mempool is present in OpenJDK's HotSpot VM's memory handling [here][hotspot-arena].

## Performance experiment

### Intro

The mem-pool PR went stale, because there were no noticeable performance improvements
over the main branch.

Looking at other GC implementations along with the current mempool PR. There are some
quick takeaways. The current `mempool` implementation preallocates `Chunks` and then
writes to the chunks. This is a good start to the approach.

One primary concept that is missing to be cache-friendly is regions -- or blocks --
that are populated with chunks. Allocating all the chunks within one region or block
further guarantees their locality to one another. This locality is the strength of using
a mempool / arena.

Claim: mempool is a good starting point, but its strength will not be obvous without
a region or block implemented with the mempool.

To test the above claim, we run the V8 benches with the `main` branch and the
`mempool` branch.

### Outcome

Current baseline of Boa's main-2025-11-19.

```txt
❯ perf stat -B -e cache-references,cache-misses,cycles,instructions,branches,faults,migrations ./target/release/boa ../boa-data/bench/bench-v8/combined.js
PROGRESS Richards
RESULT Richards 248
PROGRESS DeltaBlue
RESULT DeltaBlue 243
PROGRESS Encrypt
PROGRESS Decrypt
RESULT Crypto 193
PROGRESS RayTrace
RESULT RayTrace 495
PROGRESS Earley
PROGRESS Boyer
RESULT EarleyBoyer 584
PROGRESS Splay
RESULT Splay 692
PROGRESS NavierStokes
RESULT NavierStokes 416
SCORE 371

 Performance counter stats for './target/release/boa ../boa-data/bench/bench-v8/combined.js':

     7,008,526,837      cache-references:u                                                    
       288,056,938      cache-misses:u                   #    4.11% of all cache refs         
   325,144,171,744      cycles:u                                                              
 1,056,760,648,752      instructions:u                   #    3.25  insn per cycle            
   205,718,149,600      branches:u                                                            
           115,493      faults:u                                                              
                 0      migrations:u                                                          

      69.014224135 seconds time elapsed

      68.660092000 seconds user
       0.293880000 seconds sys
```

Performance with mem-pool PR:

```txt
❯ perf stat -B -e cache-references,cache-misses,cycles,instructions,branches,faults,migrations ./target/release/boa ../boa-data/bench/bench-v8/combined.js
PROGRESS Richards
RESULT Richards 205
PROGRESS DeltaBlue
RESULT DeltaBlue 212
PROGRESS Encrypt
PROGRESS Decrypt
RESULT Crypto 173
PROGRESS RayTrace
RESULT RayTrace 450
PROGRESS Earley
PROGRESS Boyer
RESULT EarleyBoyer 495
PROGRESS Splay
RESULT Splay 668
PROGRESS NavierStokes
RESULT NavierStokes 384
#SCORE 330
GC Stats:
{
    16: 3,
    40: 18,
    72: 600209,
    96: 267,
    104: 17740034,
    112: 211168,
    144: 870,
    184: 44,
    192: 1,
    216: 299038,
    1648: 1,
}
------------------------------------------------------------


 Performance counter stats for './target/release/boa ../boa-data/bench/bench-v8/combined.js':

     8,926,524,587      cache-references:u                                                    
       488,673,035      cache-misses:u                   #    5.47% of all cache refs         
   369,470,734,647      cycles:u                                                              
 1,156,973,842,398      instructions:u                   #    3.13  insn per cycle            
   217,393,051,485      branches:u                                                            
           129,312      faults:u                                                              
                 0      migrations:u                                                          

      78.124408957 seconds time elapsed

      77.721304000 seconds user
       0.340847000 seconds sys
```

It does appear that based off the above data that we are not improving the locality or
defragmenting the memory. This is concluded based off both the cache-misses and the 
faults that are occuring. In fact, both cache-misses and faults increase with the
current `mempool` PR.

## Conclusion

We need to further iterate on `mempool` with a region / blog of chunks, and test it's
performance with that extra type.


[hotspot-arena]: https://github.com/openjdk/shenandoah/blob/master/src/hotspot/share/memory/arena.hpp
